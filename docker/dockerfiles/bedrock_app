FROM python:2-stretch

# from https://github.com/mozmeao/docker-pythode/blob/master/Dockerfile.footer

# Extra python env
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
ENV PIP_DISABLE_PIP_VERSION_CHECK=1

# add non-priviledged user
RUN adduser --uid 1000 --disabled-password --gecos '' --no-create-home webdev

# Add apt script
COPY docker/bin/apt-install /usr/local/bin/

# end from Dockerfile.footer

WORKDIR /app
EXPOSE 8000
CMD ["./bin/run.sh"]

RUN apt-install gettext build-essential libxml2-dev libxslt1-dev libxslt1.1 git

COPY ./requirements /app/requirements

# Install Python deps
RUN pip install --no-cache-dir -r requirements/prod.txt
RUN pip install --no-cache-dir -r requirements/docker.txt

# changes infrequently
COPY ./bin ./bin
COPY ./etc ./etc
COPY ./lib ./lib
COPY ./root_files ./root_files
COPY ./scripts ./scripts
COPY ./wsgi ./wsgi
COPY manage.py LICENSE newrelic.ini contribute.json ./

# changes more frequently
COPY ./docker ./docker
COPY ./vendor-local ./vendor-local
COPY ./bedrock ./bedrock
COPY ./media ./media
COPY ./static_build ./static_build

RUN honcho run --env docker/envfiles/prod.env docker/bin/build_staticfiles.sh

# build args
ARG GIT_SHA=none
ARG BRANCH_NAME=master
ENV GIT_SHA ${GIT_SHA}
ENV BRANCH_NAME=${BRANCH_NAME}
RUN echo "${GIT_SHA}" > ./static/revision.txt
RUN bin/run-sync-all.sh

# Change User
RUN chown webdev.webdev -R .
USER webdev
